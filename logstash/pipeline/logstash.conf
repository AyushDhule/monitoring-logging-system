input {
  # Receive logs from Filebeat
  beats {
    port => 5044
  }

  # Receive JSON logs directly (from apps, curl tests, etc.)
  tcp {
    port => 5000
    codec => json
  }
}

filter {
  # Parse application logs with timestamp and level
  if [message] =~ /^\d{4}-\d{2}-\d{2}/ {
    grok {
      match => {
        "message" => "%{TIMESTAMP_ISO8601:log_timestamp} %{LOGLEVEL:level}%{SPACE}%{GREEDYDATA:log_message}"
      }
      overwrite => ["message"]
    }
    date {
      match => ["log_timestamp", "ISO8601"]
      remove_field => ["log_timestamp"]
    }
  }

  # Tag high-priority logs
  if [level] in ["ERROR", "CRITICAL"] {
    mutate {
      add_tag => ["alert", "high-priority"]
    }
  }

  # Add environment metadata
  mutate {
    add_field => {
      "environment" => "production"
      "stack"       => "monitoring-logging"
    }
  }

  # Remove noisy fields
  mutate {
    remove_field => ["agent", "ecs", "input", "log"]
  }
}

output {
  elasticsearch {
    hosts    => ["elasticsearch:9200"]
    user     => "elastic"
    password => "${ELASTIC_PASSWORD:changeme123}"
    index    => "logs-%{[fields][log_type]:app}-%{+YYYY.MM.dd}"
  }

  # Print alerts to stdout for visibility
  if "alert" in [tags] {
    stdout {
      codec => rubydebug
    }
  }
}
